<% include ./partials/navbar %>
<% include ./partials/footer %>
<% include ./partials/messages %>
<p id="vendorId"><%= vendorId %></p>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="/stylesheets/table-sortable.css">
<script src="/scripts/table-sortable.js" ></script>

<h3 style="text-align: center;">Item Description</h3>
<div class="container">
    <div class="row mt-5 mb-3 align-items-center">
        <div class="col-md-6" style="display: flex;align-items: center;" >
            <a class="btn btn-primary btn-md bg-gray" style="margin-right: 5px;" href="/procurement/ItemDescription/<%=vendorId %>" target="_blank" id="createNewItem">Create New</a>
            <button style="margin:0 10px 0 5px" class="btn btn-primary btn-md bg-gray" disabled id="deleteRecord" >Delete Records </button>
            <a class="btn btn-primary btn-md bg-gray" href="/procurement/ItemDescriptionViewRel/<%=vendorId %>" >Go To Impaneled Vendor </a>
             <a id="refresh" href="#" ><i class="fa fa-refresh" style="font-size:34px; margin-left: 10px;color: #555;"></i></a>
               </div>
        <div class="col-md-3">
        <input type="text" class="form-control" placeholder="Search " id="searchField" style="margin-top: 5px;">
        </div>
        <div class="col-md-2 text-right">
        <span class="pr-2">Rows Per Page:</span>
        </div>
        <div class="col-md-1">
            <div class="d-flex justify-content-end">
                <select class="custom-select" name="rowsPerPage" id="changeRows">
                    <option value="5">5</option>
                    <option value="10">10</option>
                    <option value="15" selected>15</option>
                </select>
            </div>
        </div>
 </div>

 <div id="ItemDescriptionTable" class="table-responsive ">

 </div>
 

</div>
<!-- DEtail Modal -->

  <div class="modal fade" id="itemModalDetail">
    <div class="modal-dialog modal-lg">
    <div class="modal-content">
   
    <!-- Modal Header -->
    <div class="modal-header">
    <center><h4 class="modal-title">Item Description View</h4></center>
    <button type="button" class="close" data-dismiss="modal">&times;</button>
    </div>
   
    <!-- Modal body -->
    <div class="modal-body">
    <div class="row">
    <div class="col-md-12">
    <nav>
    <div class="nav nav-tabs nav-fill" id="nav-tab" role="tablist">
    <a class="nav-item nav-link active" id="nav-home-tab" data-toggle="tab" href="#nav-home" role="tab" aria-controls="nav-home" aria-selected="true">Details</a>
    <a class="nav-item nav-link" id="nav-profile-tab" data-toggle="tab" href="#nav-profile" role="tab" aria-controls="nav-profile" aria-selected="false">Related</a>
    </div>
    </nav>
    <div class="tab-content" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab" style="overflow-x: auto;">
    <!-- Particular Asset Details -->
    <table id="itemDetailTable" class="table">

    </table>
    <!-- Particular Asset Details-->
    </div>
                               
    <div class="tab-pane fade" id="nav-profile" role="tabpanel" aria-labelledby="nav-profile-tab">
      <div class="accordion" id="accordionExample">
            <div class="card">
              <div class="card-header" id="headingFour">
                  <h5 class="mb-0">
                  <button class="btn btn-link collapsed text-left" type="button"
                      data-toggle="collapse" data-target="#collapseFour"
                      aria-expanded="false" aria-controls="collapseFour">
                      <i class="fa fa-angle-double-right mr-3"></i>Notes/Attachments 
                           </button>
      <!-- <button class="btn btn-primary float-right" id="pettyCashButton" >New</button> -->
                      <a href="#" class="btn btn-primary float-right notes" id="notes" style="color:white;" >New</a>
                  </h5>
                </div>
                <div id="collapseFour" class="collapse fade" aria-labelledby="headingFour" data-parent="#accordionExample">
                  <div class="card-body">
      <table id="notesbuttontable" class="table table-hover striped">
      </table>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
      </div>
     
      </div>
   
    <!-- Modal footer -->
    <div class="modal-footer">
    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
    </div>
   
    </div>
    </div>
   </div>


<!-- Edit modal Item DEscription -->

<div id="itemModal" class="modal fade ">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Item Description Edit Form</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      
        <div class="modal-body" id="editModalBody" >
        <div id="errorMessages"></div>
            <form name="edititem" id="edititem" >
             <div class="form-group">
                <div class="row">
                    <div class="col-md-6">
                      <label for="itemname"> Item Description Name</label>
                      <input type="text" disabled class="form-control" id="itemname" value=""   name="itemname" >
                    </div>
                    <div class="col-md-6">
                        <label for="vendor">Vendor Name </label>
                        <input type="text" disabled class="form-control" id="vendor" value=""   name="vendor" >
                      </div>
                </div>
              </div>
              <div class="form-group">
                <div class="row">
                  
                  
                  <div class="col-md-6">
                  <label for="cate">Item Category <span style="color: red;">*</span> </label>
                    <select id="cate" name="cate" class="form-control item_unit"><option value="">Select</option></select>
                  </div>
                  <div class="col-md-6">
                    <label for="item">  Item <span style="color: red;">*</span> </label>
                    <select id="item" name="item" class="form-control item_unit" ><option value="">Select</option></select>
                    </div>
                </div>
            </div>


            <div class="form-group">
                <div class="row">
                  <div class="col-md-6">
                  <label for="unit">Unit <span style="color: red;">*</span> </label>
                    <input type="text" class="form-control" id="unit" value=""   name="unit" >
                  </div>
                  <div class="col-md-6">
                    <label for="cost"> Per Unit Cost <span style="color: red;">*</span></label>
                    <input type="number" class="form-control" id="cost" value=""   name="cost" >
                    </div>
                </div>
            </div>
             

              <div class="form-group">
                  <div class="row">
                    <div class="col-md-6">
                        <label for="other"> Other Items</label>
                        <input type="text" class="form-control" id="other" value=""   name="other" >
                        </div>
                      <div class="col-md-6">
                        <input type="hidden" class="form-control" id="hide" value=""   name="hide" >
                        <label for="description"> Item Description/Details</label>
                        <textarea name="description" class="form-control" id="description" > </textarea>
                        </div>
                  </div>     
              </div>
              <div class="modal-footer">
                  <button type="submit" class="btn btn-primary" id="editItemButton" data-dismiss="modal">Save</button>
                  <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
              </div>
            </form>
          </div>
  </div>
</div>
</div></div>

<script>
  
    $(document).ready(function(){
        $('#vendorId').hide();
        var id = document.getElementById('vendorId').innerHTML;
       // alert('id '+id);

        let columns ={
            sequence : 'Sequence',
            isChecked : '<input style="height: 14px;width: 14px;" type="checkbox" id="allCheck" />',
            name: ' Item ID',
            category: 'Item Category',
            item : 'Items',
            unit:'Unit',
            cost:'Per Unit Cost',
           createdDate:'Created Date',
           editAction:'Action'
        }
        var table = $('#ItemDescriptionTable').tableSortable({
            data :[],
            columns,
            searchField: '#searchField',
            sorting: true,
            rowsPerPage: 15,
            pagination:true,
            sorting: ['name','sequence','createdDate'],

            tableWillMount: () => {
                console.log('table will mount')
                
            },
            tableDidMount: () => {
                console.log('table did mount');

                $('#spinner').hide();
            },
            tableWillUpdate: () => {
                console.log('table will update')
            //  table.refresh();
            // onLoadTask();
            },
            tableDidUpdate: () => {
            console.log('table did update');
             anchorClickFunctionalities();
               additionalEditFunctionality();
            
            },
            tableWillUnmount: () => console.log('table will unmount'),
            tableDidUnmount: () => console.log('table did unmount'),
            onPaginationChange: function(nextPage, setPage) {
                setPage(nextPage);
            },
        
        });
        $('#changeRows').on('change', function() {
            table.updateRowsPerPage(parseInt($(this).val(), 15));
        })
    
           $('#refresh').click(function() {
                window.location.reload();
            })    
            $.ajax({
                url : '/procurement/getItemList',
                type:'get',
                data:{id:id},
                dataType: 'json'
           })
           .done((response) => {
               console.log('response item : '+JSON.stringify(response));
               table.setData(response, columns);
               anchorClickFunctionalities();
               additionalEditFunctionality();
              
              
            })
          .fail((jqXHR, status, error) =>{
              console.log('jqXHR  : '+JSON.stringify(jqXHR));
              console.log('error  : '+error);
            })
    })

    $('#deleteRecord').on('click',function(){
        let idList = [];
        $('.checkBoxes').each(function(){
            if(this.checked){
                idList.push(this.id);
            }

        })

        if(confirm('Are you sure to delete these records?') && idList.length > 0 ){
            console.log(idList);
            $.ajax({
                    url : '/procurement/deleteItem',
                    type:'post',
                    data: {list:JSON.stringify(idList)},
                })
                .done((data) => {
                    if(data === 'Deleted Successfully')
                        window.location.reload();
                    else
                      alert(data);  
                })
                .fail(error=>{
                    console.log(error);
                    alert('Some Error Occured');
                })
        }
        else{
            console.log('not done');
        }


   });



    function anchorClickFunctionalities()
        {

            $('#allCheck').on('click',function(){
            let isTrue = this.checked;
            $('#deleteRecord').attr('disabled',!isTrue)
            $('.checkBoxes').each(function(){
                this.checked = isTrue;
            })  

        })

        $('.checkBoxes').on('click',function(){
            let count = 0;
             let counter = 0;
            $('.checkBoxes').each(function(){
                if(this.checked){
                    count++;
                    counter++;
                }
                else{
                    count--;
                }
            })

            if(counter > 0 ){
                $('#deleteRecord').attr('disabled',false);
            }
            else{
                $('#deleteRecord').attr('disabled',true)
            }
            if($('.checkBoxes').length === count){
                $('#allCheck').prop('checked',true);
            }
            else{
                $('#allCheck').prop('checked',false);
            }


        });


                $('a.itemDetailTag').on('click',function(event){
                        event.stopImmediatePropagation();
                        event.stopPropagation();
                        $('#itemModalDetail').modal('show');
                        let itemId = this.id;
                      //  alert('itemId  '+itemId);
                        $('#itemModalDetail').modal('show');
                        $.ajax({
                            url : '/procurement/getItemDetail',
                            type:'get',
                            data : {
                                itemId : itemId
                            },
                            dataType: 'json',
                            beforeSend : function(){
                              $('#detailLoadingSpinner').show();
                            }
                        })
                        .done((response) => {
                            console.log('Item DEatil  : '+JSON.stringify(response));
                            $('#detailLoadingSpinner').hide();
                            if(response.length > 0)
                            {
                                let htmlTable='';
                              htmlTable += '<tr>';
                                  htmlTable += '<td><strong>Name</strong></td>';
                                  htmlTable += '<td>'+response[0].itemname+'</td>';
                                  htmlTable += '<td><strong>Vendor Name</strong></td>';
                                  htmlTable += '<td><a target="_blank" href="/procurement/ItemDescriptionViewRel/<%=vendorId %>">'+response[0].vendername+'</a></td>';
                              htmlTable += '</tr>';
                              htmlTable += '<tr>';
                                htmlTable += '<td><strong>Item Category</strong></td>';
                                htmlTable += '<td>'+response[0].category__c+'</td>';
                                htmlTable += '<td><strong> Item</strong></td>';
                                htmlTable += '<td>'+response[0].items__c+'</td>';
                            htmlTable += '</tr>';
                            htmlTable += '<tr>';
                                htmlTable += '<td><strong>Unit </strong></td>';
                                htmlTable += '<td>'+response[0].unit__c+'</td>';
                                htmlTable += '<td><strong>Per Unit Cost</strong></td>';
                                htmlTable += '<td>'+response[0].per_unit_cost__c+'</td>';
                            htmlTable += '</tr>';
                            htmlTable += '<tr>';
                                htmlTable += '<td><strong>Other </strong></td>';
                                htmlTable += '<td>'+response[0].other_items__c+'</td>';
                                htmlTable += '<td><strong>Quote URL </strong></td>';
                                if(response[0].public_quote_url__c!="demo"){
                                if(response[0].public_quote_url__c!=null){
                                  htmlTable += '<td>'+'<a href="'+response[0].public_quote_url__c+'" target="_blank">Click to View </a></td>';
                                }
                                }
                                else{
                                  htmlTable +='<td></td>';
                                }
                            htmlTable += '</tr>';

                            htmlTable += '<tr>';
                                htmlTable += '<td><strong>Item Description/Details </strong></td>';
                                htmlTable += '<td>'+response[0].description+'</td>';
                                htmlTable += '<td><strong></strong></td>';
                                htmlTable += '<td></td>';
                            htmlTable += '</tr>';
                              $('#itemDetailTable').empty();
                              $('#itemDetailTable').html(htmlTable);
                            }

                        })
                        .fail((jqXHR, status, error) =>{
                            $('#detailLoadingSpinner').hide();
                            console.log('jqXHR  : '+JSON.stringify(jqXHR));
                            console.log('error  : '+error);
                          })

                          $('a.notes').on('click',function(event)
                          {
                            //alert('Hello'+this.id);
                        // var itemId = document.getElementById('vendorId').innerHTML;
                            console.log('itemId notes : '+itemId);
                          // location.assign('/procurement/upload/'+assetId);
                            window.open('/procurement/uploadItemNotes/'+itemId,'_blank');
                            })
                          
                })

               
            }


    function additionalEditFunctionality(){
        $('.editItem').on('click',function(event){
            event.stopPropagation();
            event.stopImmediatePropagation();
            let itemId = this.id;
            
    var itemsCategory = [ "Electrical", "Events", "IT", "Materials On Rent", "Miscellaneous","Printing","Stationery" ];
    var Stationery = ["A4 Size Paper Rim","Books","Eraser","Files","Magnetic Board","Markers", "Others", "Pen", "Pencil","Sharpner","White", ];
    var Printing = ["Binding","Brochures","Caps", "Certificates", "Leaflets","Others", "Posters", "Standees" ];
    var Electrical = ["Battery", "Camera", "Extension Board", "Fan" , "Heater", "Inverter", "LCD Projector", "Lights", "Others", "Plasma", "Telephone", "UPS"  ];
    var Events = ["Others", "Suggest Hotels"];
    var IT = ["Cartridge","CPU", "Desktop","Desktop Mouse", "External Hard Disk", "Keyboard", "Laptop" ,"Laptop Charger", "Monitor", "Others", "Pen Drive", "Printer", "RAM", "Server", "Software","Tablet"];
    var MaterialsOnRent = [ "AV Systems", "Backdrop", "Hardware Peripherals", "Others" , "Projector"];
    var Miscellaneous = ["Any Other Expense", "Maintenance"];
    
     $('#cate').find('option').not(':first').remove();
     $('#item').find('option').not(':first').remove();
    for(i=0;i<itemsCategory.length;i++)
    {
       $('#cate')
               .append($("<option></option>")
               .attr("value",itemsCategory[i])
               .text(itemsCategory[i]));		
    }


    $('#cate').on('change',function(){
        $('#item').find('option').not(':first').remove();
        let dt = eval(this.value.replaceAll(' ',''));
            console.log(dt);

            dt.forEach(dts=>{
                $('#item')
               .append($("<option></option>")
               .attr("value",dts)
               .text(dts));

            })



    })

    
         //   alert(' editItem Modal ID=>'+itemId);
              $('#itemModal').modal('show'); 
              $.ajax({
                url : '/procurement/getItemDetail',
                type:'get',
                data : {
                    itemId : itemId
                },
                dataType: 'json',
                beforeSend : function(){
                  $('#detailLoadingSpinner').show();
                }
            })
            .then((response)=>{
            console.log('response from Item Edit Ajax +='+JSON.stringify(response[0]));
            document.forms["edititem"]["itemname"].value = response[0].itemname;
            document.forms["edititem"]["vendor"].value = response[0].vendername;
            document.forms["edititem"]["cate"].value = response[0].category__c;
            //document.forms["edititem"]["item"].value = response[0].items__c;
            document.forms["edititem"]["unit"].value = response[0].unit__c;
            document.forms["edititem"]["cost"].value = response[0].per_unit_cost__c;
            document.forms["edititem"]["other"].value = response[0].other_items__c;
            document.forms["edititem"]["hide"].value = response[0].sfid;
            document.forms["edititem"]["description"].value = response[0].description;

            let dt = eval(response[0].category__c.replaceAll(' ',''));
            console.log(dt);

            dt.forEach(dts=>{
                $('#item')
               .append($("<option></option>")
               .attr("value",dts)
               .text(dts));

            })

               $('#item').val(response[0].items__c);
           // response[0].category__c;



            })
            .fail((jqXHR, status, error) =>{
                $('#detailLoadingSpinner').show();
                console.log('jqXHR  : '+JSON.stringify(jqXHR));
                console.log('error  : '+error);
              })
        })
        $('#editItemButton').on('click',function(event){
            event.preventDefault();
                      event.stopPropagation();
                      event.stopImmediatePropagation();
                  //    alert('Save Button Clicked !');
                      var $inputs = $('#edititem :input');
  
                      // not sure if you wanted this, but I thought I'd add it.
                      // get an associative array of just the values.
                      var values = {};
                      $inputs.each(function() {
                          values[this.name] = $(this).val();
                          console.log('fomvalues=> '+JSON.stringify(values));
                      });
                      console.log('fomvalues=> '+JSON.stringify(values));
                      $("#editItemButton").attr("disabled", true);
                  //    alert('formValues : '+JSON.stringify(values));
                      $.ajax({
                        url : '/procurement/updateItemescription',
                        type:'post',
                        data: values,
                        dataType : 'json'
                    })
                    .done((response) => {
                          console.log('resonse   :'+response);
                          alert("Item Description succesfullly Updated!");
                          window.location.reload();
                    })
                    .fail((jqXHR, status, error) => {

                        if(jqXHR.responseText !== 'Success'){

                          let errorHtml = '<div class="alert alert-danger alert-dismissible fade show" role="alert">'+jqXHR.responseText+
                          '<button type="button" class="close" data-dismiss="alert" aria-label="Close">'+
                          '<span aria-hidden="true">&times;</span>'+
                          '</button>'+
                          '</div>';
                          $('#errorMessages').empty();
                          $('#errorMessages').append(errorHtml); 
                          $("#editItemButton").attr("disabled", false);
                      }
                      else{
                        alert("Item Description succesfullly Updated!");
                          window.location.reload();
                      }

                          console.log('jqXHR  '+JSON.stringify(jqXHR));
                    }) 
                    })
        
    }

   
  

</script>
